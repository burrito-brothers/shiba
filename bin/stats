#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path("../lib", File.dirname(__FILE__))
require 'optionparser'
require 'shiba'
require 'shiba/stats/cli'
require 'shiba/index_stats'
require 'open3'

cli = Shiba::Stats::CLI.new
options = cli.options

if options[:verbose]
  puts "Options: #{options.inspect}"
end

if !cli.valid?
  $stderr.puts cli.failure
  exit 1
end

def run(command)
  out    = nil
  thread = nil

  Open3.popen2e(command) {|_,eo,th|
    out    = eo.readlines
    thread = th
  }

  return out, thread.value.exitstatus
end

cmd = ""
output = nil
output = File.read(options[:file]) if options[:file]
output ||= if options[:host] != 'localhost'
  if options[:proxy]
    cmd << "ssh -o ProxyCommand='ssh -W' %h:%p #{options[:proxy]} -t #{options[:host]}"
  else
    cmd << "ssh #{options[:host]}"
  end

  cmd << " '#{cli.query_script}'"

  if options[:script]
    puts cmd
    exit
  end

  out, status = run(cmd)
  if status != 0
    $stderr.puts "Error during stats import:"
    $stderr.puts out
    $stderr.puts "--- script --- "
    $stderr.puts cmd
    exit 1
  end
  out
else
  if options[:script]
    puts cli.query_script
    exit
  end

  out, status = run(cli.query_script)
  if status != 0
    $stderr.puts "Error during stats import:"
    $stderr.puts out
    $stderr.puts "--- script --- "
    $stderr.puts cli.query_script
    exit 1
  end
  out
end

records = if options[:server] == "mysql"
  Shiba::Stats::Mysql.new.parse(output)
else
  Shiba::Stats::Postgres.new.parse(output)
end

index = Shiba::IndexStats.from_records(records)
puts index.to_yaml