#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path("../lib", File.dirname(__FILE__))
require 'optionparser'
require 'shiba'
require 'shiba/stats/cli'
require 'shiba/index_stats'
require 'open3'

cli = Shiba::Stats::CLI.new
options = cli.options

if options[:verbose]
  puts "Options: #{options.inspect}"
end

if !cli.valid?
  $stderr.puts cli.failure
  exit 1
end

if options[:file]
  output = File.read(options[:file])
  puts cli.raw_stats_to_yaml(output)
  exit
end

script = if options[:host] != 'localhost'
  cmd = ""
  if options[:proxy]
    cmd << "ssh -o ProxyCommand='ssh -W' %h:%p #{options[:proxy]} -t #{options[:host]}"
  else
    cmd << "ssh #{options[:host]}"
  end

  cmd << " '#{cli.query_script}'"
  cmd
else
  cli.query_script
end

if options[:script]
  puts cmd
  exit
end

out, status = cli.run(cmd)
if status != 0
  $stderr.puts "Error during stats import:"
  $stderr.puts out
  $stderr.puts "--- script --- "
  $stderr.puts cmd
  exit 1
end

puts cli.raw_stats_to_yaml(out)