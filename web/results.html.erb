<html>
  <head>
    <title>Shiba results for <%= Time.now %></title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
  </head>
  <body>
    <% data[:js].each do |js| %>
    <script type="text/javascript">
      <%= File.read(js) %>
    </script>
    <% end %>

    <% data[:css].each do |css| %>
      <style type="text/css">
        <%= File.read(css) %>
      </style>
    <% end %>

    <script language="javascript">
      var data = <%= data.to_json %>;
      var queriesByTable = [];
      var queriesByTableLow = [];


      function sortByTable(a, b) {
        if ( a.table < b.table )
          return -1;
        else if ( b.table < a.table )
          return 1;
        else {
          return b.cost - a.cost;
        }
      }

      data.queries.forEach(function(query) {
        if ( query.cost < 100 ) {
          queriesByTableLow.push(query);
        } else {
          queriesByTable.push(query);
        }

        if ( !query.tags.includes("fuzzed_data") )
          query.costAvailable = true;

        query.expandSelect = false;
      });

      queriesByTable = queriesByTable.sort(sortByTable);
      queriesByTableLow = queriesByTableLow.sort(sortByTable);
    </script>

    <script type="text/x-template" id="query-template">
      <div class="query">
        <div class="row">
          <div class="col-3">
            <a href="#" v-on:click="expandToggle">
              <span stlye="text-align: right">{{ expandText }}</span>
            </a>
            {{ query.table }}
          </div>
          <div class="col-5">{{ truncate(query.sql, 50) }}</div>
          <div class="col-3" v-html="makeURL(query.backtrace[0], shortLocation(query))"></div>
          <div class="col-1">{{ query.severity }}</div>
        </div>
        <div class="row" v-if="expanded">
          <div class="col-12">
            <div class="query-info-box">
              <query-sql v-bind:sql="query.sql"></query-sql>
              <div v-if="query.backtrace && query.backtrace.length > 0">
                Stack Trace:<br>
                <div class="backtrace">
                  <div v-for="backtrace in query.backtrace" v-html="makeURL(backtrace, backtrace)"></div>
                </div>
              </div>
              Index used: {{ castNull(query.key) }}<br>
              <div v-if="query.possible_keys && query.possible_keys.length > 0 || !query.key">
                Indexes considered: {{ castNull(query.possible_keys) }}
              </div>
              Rows checked: {{ query.cost }}<br>
              <a class="badge"
                v-for="tag in query.tags"
                href="#"
                v-bind:class="tagClass(tag)"
                v-on:click="expandInfo(tag, $event)">{{ tagTitle(tag) }}</a>
            </div>
          </div>
        </div>
      </div>
    </script>
    <script type="text/x-template" id="sql-template">
      <div class="sql">
        <span>{{ select }}</span>
        <span v-if="!expandFields && fields.length > 80">
          <a href="#" v-on:click.prevent="expandFields = !expandFields">...</a>
        </span>
        <span v-else>{{ fields }}</span>
        <span>{{ rest }}</span>
      </div>
    </script>
    <script>
      Vue.component('query-sql', {
        template: '#sql-template',
        props: ['sql'],
        data: function () {
          return { expandFields: false }
        },
        computed: {
          sqlFragments: function() {
            var result = this.sql.match(/(SELECT\s)(.*?)(\s+FROM .*)/i);
            return [result[1], result[2], result[3]];
          },
          select: function () {
            return this.sqlFragments[0];
          },
          fields: function () {
            return this.sqlFragments[1];
          },
          rest: function() {
            return this.sqlFragments[2];
          }
        }
      });
    </script>
    <div id="app">
      <v-dialog :width="600"></v-dialog>
      <div class="container" style="">
        <div class="row">
          <div class="col-12">We found {{ queries.length }} queries that deserve your attention: </div>
        </div>
        <div class="row">
          <div class="col-3">Table</div>
          <div class="col-5">Query</div>
          <div class="col-3">Source</div>
          <div class="col-1">Severity</div>
        </div>
        <div class="queries">
          <query v-for="query in queries" v-bind:query="query" v-bind:key="query.sql" v-bind:tags="tags"></query>
        </div>
        <div class="row">
          <div class="col-12">We also found <a href="#" v-on:click.prevent="lowExpanded = !lowExpanded">{{ queriesLow.length }} queries</a> that look fine.</div>
        </div>
        <a name="lowExapnded"></a>
        <div class="queries" v-if="lowExpanded">
          <query v-for="query in queriesLow" v-bind:query="query" v-bind:key="query.sql" v-bind:tags="tags"></query>
        </div>
        <div style="height:50px"></div>
      </div>
    </div>

  <script>
    Vue.component('query', {
      template: '#query-template',
      props: ['query', 'tags', 'github'],
      data: function () {
        return {
          expanded: false
        };
      },
      methods: {
        truncate: function (string, len) {
          if ( string.length > len ) {
            return string.substring(0, len - 3) + "...";
          } else {
            return string;
          }
        },
        expandInfo: function(tag, event) {
          this.$modal.show('dialog', {
            title: this.tags[tag].title,
            text: this.tags[tag].description,
            buttons: [
              {
                title: 'Close'
              }
            ]
          })
          event.preventDefault();
        },
        expandToggle: function(event) {
          if (event) event.preventDefault()
          this.expanded = !this.expanded;
        },
        castNull: function (string) {
          if ( !string )
            return "(none)";
          else
            return string;
        },
        shortLocation: function(query) {
          if ( !query.backtrace )
            return null;
          var location = query.backtrace[0];
          return location.match(/([^\/]+:\d+):/)[1];
        },
        makeURL: function(line, content) {
          if ( !data.url )
            return content;

          var matches = line.match(/(.+):(\d+):/);
          var file = matches[1].replace(/^\/+/, '');
          var line = matches[2];

          return `<a href='${data.url}/${file}#L${line}' target='_new'>${content}</a>`;
        },
        tagTitle: function(tag) {
          if ( !this.tags[tag] )
            return tag;
          else
            return this.tags[tag].title;
        },
        tagClass: function(tag) {
          if ( !this.tags[tag] )
            return '';
          else
            return "badge-" + this.tags[tag].level;
        }
      },
      computed: {
        expandText: function() {
          return this.expanded ? "-" : "+";
        },
      }
    });

    var app = new Vue({
      el: '#app',
      data: {
        queries: queriesByTable,
        queriesLow: queriesByTableLow,
        tags: data.tags,
        lowExpanded: false
      },
      methods: { }
    });


    </script>
  </body>
</html>
